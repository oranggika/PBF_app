<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title>Identitas Negara PBF with Add Card & Publish</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap");
  </style>
</head>
<body
  class="bg-[#0046bb] min-h-screen flex flex-col items-center py-8 px-4"
>
  <h1
    class="text-white font-mono text-[28px] sm:text-[32px] md:text-[36px] font-extrabold mb-6 select-none"
    style="font-family: 'Roboto Mono', monospace"
  >
    IDENTITAS NEGARA PBF
  </h1>

  <div class="flex flex-wrap gap-4 mb-6 w-full max-w-[1200px] justify-center">
    <button
      id="addCardBtn"
      class="bg-white text-[#0046bb] font-semibold rounded-lg px-6 py-3 shadow-md hover:bg-gray-100 transition select-none flex items-center justify-center gap-2"
      title="Tambah Kartu Baru"
    >
      <i class="fas fa-plus"></i> + Kartu
    </button>
    <button
      id="publishBtn"
      class="bg-white text-[#0046bb] font-semibold rounded-lg px-6 py-3 shadow-md hover:bg-gray-100 transition select-none flex items-center justify-center gap-2"
      title="Publish semua kartu agar bisa dilihat semua orang"
    >
      <i class="fas fa-bullhorn"></i> Publish
    </button>
  </div>

  <div
    id="cards-container"
    class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8 max-w-[1200px] w-full"
  >
    <!-- Cards will be generated by JS -->
  </div>

  <script>
    const fontFamily = "'Roboto Mono', monospace";
    const STORAGE_KEY = "pbfCardsDataShared";
    const USER_ID_KEY = "pbfUserId";

    // Generate or get unique user ID (simple UUID v4)
    function getUserId() {
      let id = localStorage.getItem(USER_ID_KEY);
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem(USER_ID_KEY, id);
      }
      return id;
    }
    const currentUserId = getUserId();

    // Default placeholder image URL
    const defaultImageURL =
      "https://placehold.co/120x80?text=FOTO+%22BISA+DI+ISI+COSTOM%22&font=roboto-mono&font-size=12&text-align=center&bg=ffffff&fg=4a4a4a";

    // Default signature image URL
    const defaultSignatureURL =
      "https://placehold.co/120x40?text=Tanda+tangan+pendiri+PBF&font=roboto-mono&font-size=10&text-align=center&bg=f3f3f3&fg=4a4a4a";

    // Load all cards data from localStorage or empty array
    function loadData() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch {
          return [];
        }
      }
      return [];
    }

    // Save all cards data to localStorage
    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // Create a new empty card assigned to current user
    function createEmptyCard(userId) {
      return {
        userId: userId,
        imageURL: defaultImageURL,
        namaNegara: "",
        namaMataUang: "",
        namaPresiden: "",
        merdekaPada: "",
        signatureURL: defaultSignatureURL,
        signatureText: "Tanda tangan pendiri PBF",
        isComplete: false,
      };
    }

    // Create card element with editing enabled only if owned by current user
    function createCardElement(cardData, index, dataArray) {
      const isOwner = cardData.userId === currentUserId;

      const card = document.createElement("div");
      card.className =
        "bg-white rounded-xl border-4 border-[#4a3c2a] p-4 flex flex-col items-center max-w-[220px] mx-auto";

      // Image container with file input overlay if owner
      const imgContainer = document.createElement("div");
      imgContainer.className = "relative mb-4 w-[120px] h-[80px]";

      const img = document.createElement("img");
      img.src = cardData.imageURL || defaultImageURL;
      img.alt =
        'Photo box with text "FOTO \\"BISA DI ISI COSTOM\\"" placeholder or user image';
      img.className = "w-full h-full object-contain rounded-md";
      if (isOwner) img.classList.add("cursor-pointer");
      imgContainer.appendChild(img);

      if (isOwner) {
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.className =
          "absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer";
        fileInput.title = "Click to change photo";
        imgContainer.appendChild(fileInput);

        fileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              img.src = event.target.result;
              cardData.imageURL = event.target.result;
              saveData(dataArray);
              localStorage.setItem("pbfCardsDataUpdate", Date.now());
            };
            reader.readAsDataURL(file);
          }
        });
      }

      card.appendChild(imgContainer);

      // Text container
      const textContainer = document.createElement("div");
      textContainer.className =
        "w-full text-[9px] text-[#6b6b6b] font-mono leading-[1.1] mb-6";
      textContainer.style.fontFamily = fontFamily;

      function createEditableLine(label, key) {
        const p = document.createElement("p");
        p.className = "mb-1";

        const spanLabel = document.createElement("span");
        spanLabel.className = "font-semibold text-black select-none";
        spanLabel.textContent = label;
        p.appendChild(spanLabel);

        const spanText = document.createElement("span");
        spanText.contentEditable = isOwner ? "true" : "false";
        spanText.spellcheck = false;
        spanText.className = "ml-1 outline-none";
        spanText.style.userSelect = isOwner ? "text" : "none";
        spanText.textContent = cardData[key] || "";

        if (isOwner) {
          spanText.addEventListener("input", () => {
            cardData[key] = spanText.textContent;
            saveData(dataArray);
            localStorage.setItem("pbfCardsDataUpdate", Date.now());
          });
        }

        p.appendChild(spanText);
        return p;
      }

      textContainer.appendChild(createEditableLine("NAMA NEGARA", "namaNegara"));
      textContainer.appendChild(createEditableLine("NAMA MATA UANG", "namaMataUang"));
      textContainer.appendChild(createEditableLine("NAMA PRESIDEN", "namaPresiden"));
      textContainer.appendChild(createEditableLine("MERDEKA PADA", "merdekaPada"));

      card.appendChild(textContainer);

      // Signature container
      const signatureContainer = document.createElement("div");
      signatureContainer.className = "w-full flex flex-col items-center";

      const signatureImg = document.createElement("img");
      signatureImg.src = cardData.signatureURL || defaultSignatureURL;
      signatureImg.alt =
        "Signature and line with text 'Tanda tangan pendiri PBF' in black on light gray background";
      signatureImg.className = "mb-1 max-w-[120px] h-auto object-contain rounded-sm";
      signatureContainer.appendChild(signatureImg);

      const signatureText = document.createElement("div");
      signatureText.contentEditable = isOwner ? "true" : "false";
      signatureText.spellcheck = false;
      signatureText.className =
        "text-[9px] font-mono text-[#6b6b6b] select-text w-full text-center outline-none";
      signatureText.style.fontFamily = fontFamily;
      signatureText.textContent = cardData.signatureText || "Tanda tangan pendiri PBF";

      if (isOwner) {
        signatureText.addEventListener("input", () => {
          cardData.signatureText = signatureText.textContent;
          saveData(dataArray);
          localStorage.setItem("pbfCardsDataUpdate", Date.now());
        });
      }

      signatureContainer.appendChild(signatureText);

      card.appendChild(signatureContainer);

      return card;
    }

    // Validate if a card is fully filled (all text fields non-empty)
    function isCardComplete(card) {
      return (
        card.namaNegara.trim() !== "" &&
        card.namaMataUang.trim() !== "" &&
        card.namaPresiden.trim() !== "" &&
        card.merdekaPada.trim() !== ""
      );
    }

    // Render all cards
    function renderCards() {
      const container = document.getElementById("cards-container");
      container.innerHTML = "";
      const data = loadData();

      // Render all cards
      data.forEach((cardData, index) => {
        const card = createCardElement(cardData, index, data);
        container.appendChild(card);
      });
    }

    // Add new card for current user if not already have one
    function addCardForCurrentUser() {
      const data = loadData();
      const existing = data.find((c) => c.userId === currentUserId);
      if (existing) {
        alert("Anda sudah memiliki kartu, silakan isi kartu Anda yang sudah ada.");
        return;
      }
      const newCard = createEmptyCard(currentUserId);
      data.push(newCard);
      saveData(data);
      localStorage.setItem("pbfCardsDataUpdate", Date.now());
      renderCards();
      alert("Kartu baru telah ditambahkan. Silakan isi kartu Anda.");
    }

    // Publish: validate all cards are complete, then save and broadcast
    function publishCards() {
      const data = loadData();
      // Check all cards are complete
      for (const card of data) {
        if (!isCardComplete(card)) {
          alert(
            "Semua kartu harus diisi lengkap sebelum dipublikasikan. Mohon lengkapi semua kartu."
          );
          return;
        }
      }
      saveData(data);
      localStorage.setItem("pbfCardsDataUpdate", Date.now());
      alert("Semua kartu telah dipublikasikan dan dapat dilihat semua orang.");
    }

    // Listen for storage events to sync data across tabs/windows
    window.addEventListener("storage", (event) => {
      if (event.key === "pbfCardsDataUpdate") {
        renderCards();
      }
    });

    // Button event listeners
    document.getElementById("addCardBtn").addEventListener("click", () => {
      addCardForCurrentUser();
    });

    document.getElementById("publishBtn").addEventListener("click", () => {
      publishCards();
    });

    // Initial render
    renderCards();
  </script>
</body>
</html>